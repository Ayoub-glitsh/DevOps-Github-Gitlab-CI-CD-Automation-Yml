name: ğŸ”„ DevOps CI/CD Sync - GitHub to GitLab

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # DÃ©clenchement manuel
    inputs:
      branch:
        description: 'Branche Ã  synchroniser'
        required: true
        default: 'main'

jobs:
  sync-to-gitlab:
    name: ğŸš€ Synchronisation vers GitLab
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code GitHub
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Tout l'historique
          ref: ${{ github.event.inputs.branch || github.ref }}
          
      - name: ğŸ› ï¸ Configuration Git
        run: |
          git config user.name "DevOps Sync Bot"
          git config user.email "devops-sync@github.com"
          git config push.default current
          
      - name: ğŸ” Informations de dÃ©bogage
        run: |
          echo "=== INFORMATION DE SYNCHRONISATION ==="
          echo "ğŸ“¦ Repository GitHub: ${{ github.repository }}"
          echo "ğŸŒ¿ Branche: ${{ github.ref_name }}"
          echo "ğŸ‘¤ GitLab User: ayoubaguezzar1"
          echo "ğŸ”— Projet GitLab: devops-github-gitlab-ci-cd-automation-yml"
          echo "ğŸ“ Dossier: $(pwd)"
          echo "====================================="
          
      - name: ğŸ” VÃ©rifier la prÃ©sence des secrets
        run: |
          if [ -z "${{ secrets.GITLAB_TOKEN }}" ]; then
            echo "âŒ ERREUR: GITLAB_TOKEN non configurÃ©"
            echo "ğŸ‘‰ Configuration: GitHub â†’ Settings â†’ Secrets â†’ Actions"
            echo "ğŸ‘‰ Ajouter: GITLAB_TOKEN avec votre token GitLab"
            exit 1
          fi
          
          if [ -z "${{ secrets.GITLAB_USERNAME }}" ]; then
            echo "âš ï¸ AVERTISSEMENT: GITLAB_USERNAME non configurÃ©"
            echo "âš ï¸ Utilisation du username par dÃ©faut: ayoubaguezzar1"
          fi
          
      - name: ğŸš€ Synchronisation vers GitLab
        env:
          GITLAB_USER: "${{ secrets.GITLAB_USERNAME || 'ayoubaguezzar1' }}"
          GITLAB_TOKEN: "${{ secrets.GITLAB_TOKEN }}"
          GITLAB_PROJECT: "devops-github-gitlab-ci-cd-automation-yml"
        run: |
          echo "=== DÃ‰BUT SYNCHRONISATION ==="
          
          # URL GitLab personnalisÃ©e
          GITLAB_URL="https://oauth2:${GITLAB_TOKEN}@gitlab.com/${GITLAB_USER}/${GITLAB_PROJECT}.git"
          
          echo "ğŸ”— URL GitLab: https://gitlab.com/${GITLAB_USER}/${GITLAB_PROJECT}"
          echo "ğŸ“¡ Connexion Ã  GitLab..."
          
          # Ajouter GitLab comme remote
          git remote remove gitlab 2>/dev/null || true
          git remote add gitlab "${GITLAB_URL}"
          
          # RÃ©cupÃ©rer la branche actuelle
          CURRENT_BRANCH="${{ github.ref_name }}"
          echo "ğŸŒ¿ Branche source: ${CURRENT_BRANCH}"
          
          # Synchroniser la branche
          echo "ğŸ”„ Poussage vers GitLab..."
          if git push --porcelain gitlab HEAD:${CURRENT_BRANCH} --tags; then
            echo "âœ… Synchronisation rÃ©ussie!"
            echo "ğŸ“Š Statistiques envoyÃ©es avec succÃ¨s"
          else
            echo "âš ï¸ Premier Ã©chec, tentative avec --force"
            git push gitlab HEAD:${CURRENT_BRANCH} --tags --force
            echo "âœ… Synchronisation forcÃ©e rÃ©ussie!"
          fi
          
          echo "=== SYNCHRONISATION TERMINÃ‰E ==="
          
      - name: ğŸ“Š RÃ©sumÃ© de la synchronisation
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ“‹ RÃ‰SUMÃ‰ DE LA SYNCHRONISATION"
          echo "========================================"
          echo "âœ… Projet: DevOps-Github-Gitlab-CI-CD-Automation-Yml"
          echo "âœ… Source: GitHub - ${{ github.repository }}"
          echo "âœ… Destination: GitLab - ayoubaguezzar1/devops-github-gitlab-ci-cd-automation-yml"
          echo "âœ… Branche: ${{ github.ref_name }}"
          echo "âœ… DÃ©clencheur: ${{ github.event_name }}"
          echo "âœ… Statut: ${{ job.status }}"
          echo "âœ… Timestamp: $(date)"
          echo "========================================"
          echo ""
          echo "ğŸ”— Liens utiles:"
          echo "â€¢ GitHub Actions: https://github.com/${{ github.repository }}/actions"
          echo "â€¢ GitLab Project: https://gitlab.com/ayoubaguezzar1/devops-github-gitlab-ci-cd-automation-yml"
          echo ""
          echo "ğŸš€ Prochain commit â†’ Synchronisation automatique!"
          
      - name: ğŸ“§ Notification (Optionnel)
        if: success()
        run: |
          echo "ğŸ’¡ Pour ajouter des notifications:"
          echo "1. Slack: uses: 8398a7/action-slack@v3"
          echo "2. Email: Configurez les webhooks GitHub"
          echo "3. Discord: Utilisez discord-webhook-action"
          
  validation:
    name: âœ… Validation de la configuration
    runs-on: ubuntu-latest
    needs: sync-to-gitlab
    if: always()
    
    steps:
      - name: ğŸ“ Rapport final
        run: |
          echo "ğŸ‰ CONFIGURATION DEVOP VALIDÃ‰E ğŸ‰"
          echo ""
          echo "Votre pipeline CI/CD est maintenant opÃ©rationnel:"
          echo ""
          echo "1ï¸âƒ£  GitHub â†’ GitLab Synchronisation âœ…"
          echo "    Chaque commit sur GitHub est automatiquement"
          echo "    rÃ©pliquÃ© sur GitLab en moins de 30 secondes"
          echo ""
          echo "2ï¸âƒ£  SÃ©curitÃ© âœ…"
          echo "    Tokens protÃ©gÃ©s par GitHub Secrets"
          echo "    Authentification sÃ©curisÃ©e OAuth2"
          echo ""
          echo "3ï¸âƒ£  Monitoring âœ…"
          echo "    Logs dÃ©taillÃ©s dans GitHub Actions"
          echo "    Statut visible en temps rÃ©el"
          echo ""
          echo "4ï¸âƒ£  FiabilitÃ© âœ…"
          echo "    Reconnexion automatique en cas d'Ã©chec"
          echo "    Support du force push si nÃ©cessaire"
          echo ""
          echo "ğŸ“š Documentation:"
          echo "â€¢ README.md pour les instructions"
          echo "â€¢ .github/workflows/ pour la configuration"
          echo ""
          echo "ğŸš€ Votre pipeline DevOps est prÃªt!"
